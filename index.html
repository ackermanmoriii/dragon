<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Config Fetcher</title>
    <style>
        /* Brutalist CSS Style */
        :root {
            --primary: #000000;
            --secondary: #ffffff;
            --accent: #ff0000;
            --gray: #444444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        body {
            background-color: var(--primary);
            color: var(--secondary);
            padding: 20px;
            line-height: 1.4;
            border: 8px solid var(--accent);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 4px solid var(--accent);
            margin-bottom: 40px;
        }

        h1 {
            font-size: 3.5rem;
            text-transform: uppercase;
            letter-spacing: 5px;
            margin-bottom: 15px;
            color: var(--accent);
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--gray);
        }

        .status-panel {
            background-color: #111;
            padding: 25px;
            border: 3px solid var(--secondary);
            margin-bottom: 40px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            margin: 10px 0;
        }

        .last-update {
            font-size: 1.3rem;
            color: var(--accent);
            font-weight: bold;
        }

        .file-count {
            font-size: 1.3rem;
        }

        .next-update {
            font-size: 1.3rem;
            color: #00ff00;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            background-color: var(--accent);
            color: var(--secondary);
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            border: 3px solid var(--accent);
        }

        button:hover {
            background-color: transparent;
            color: var(--accent);
        }

        button:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
            border-color: var(--gray);
        }

        .files-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 50px;
        }

        .file-card {
            background-color: #111;
            padding: 20px;
            border: 3px solid var(--secondary);
            transition: all 0.3s;
        }

        .file-card:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--gray);
            padding-bottom: 10px;
        }

        .file-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--accent);
        }

        .file-size {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .file-content {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #000;
            border: 1px solid var(--gray);
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .download-btn {
            display: block;
            width: 100%;
            padding: 10px;
            text-align: center;
            background-color: var(--gray);
            color: var(--secondary);
            text-decoration: none;
            font-weight: bold;
            border: 2px solid var(--gray);
            transition: all 0.2s;
        }

        .download-btn:hover {
            background-color: transparent;
            color: var(--accent);
            border-color: var(--accent);
        }

        footer {
            text-align: center;
            padding: 30px 0;
            border-top: 4px solid var(--accent);
            color: var(--gray);
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.5rem;
            color: var(--accent);
        }

        .error {
            color: #ff4444;
            padding: 10px;
            background-color: #220000;
            border: 2px solid #ff4444;
            margin: 10px 0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--accent);
            color: var(--secondary);
            font-weight: bold;
            border: 3px solid var(--secondary);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            .controls { flex-direction: column; }
            .status-panel { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Dragon Config Fetcher</h1>
            <p class="subtitle">Fetching and updating V2ray configs from GitHub repository every hour</p>
        </header>

        <div class="status-panel">
            <div class="status-item">
                <div>Last Update:</div>
                <div id="lastUpdate" class="last-update">Never</div>
            </div>
            <div class="status-item">
                <div>Files Available:</div>
                <div id="fileCount" class="file-count">0 dragon files</div>
            </div>
            <div class="status-item">
                <div>Next Auto-Update:</div>
                <div id="nextUpdate" class="next-update">--:--:--</div>
            </div>
        </div>

        <div class="controls">
            <button id="fetchBtn" onclick="fetchConfigs()">Fetch Configs Now</button>
            <button id="refreshBtn" onclick="loadDragonFiles()">Refresh File List</button>
            <button id="clearBtn" onclick="clearAllFiles()">Clear All Files</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            Fetching configs from GitHub... This may take a moment.
        </div>

        <div id="errorContainer"></div>

        <div id="filesContainer" class="files-container">
            <!-- Dragon files will be displayed here -->
        </div>

        <footer>
            <p>This app fetches V2ray configs from <strong>Epodonios/v2ray-configs</strong> GitHub repository</p>
            <p>Configs are updated every hour automatically | Last repository update: <span id="repoUpdate">Unknown</span></p>
        </footer>
    </div>

    <script>
        // State management
        const state = {
            dragonFiles: {},
            lastUpdate: null,
            nextUpdateTime: null,
            updateInterval: null,
            isFetching: false,
            baseUrl: 'https://raw.githubusercontent.com/Epodonios/v2ray-configs/refs/heads/main/',
            subFiles: []
        };

        // DOM elements
        const filesContainer = document.getElementById('filesContainer');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const fileCountEl = document.getElementById('fileCount');
        const nextUpdateEl = document.getElementById('nextUpdate');
        const loadingEl = document.getElementById('loading');
        const errorContainer = document.getElementById('errorContainer');
        const fetchBtn = document.getElementById('fetchBtn');
        const repoUpdateEl = document.getElementById('repoUpdate');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            updateDisplay();
            startAutoUpdate();
            checkRepositoryUpdate();
        });

        // Load dragon files from localStorage
        function loadFromStorage() {
            const saved = localStorage.getItem('dragonFiles');
            const savedUpdate = localStorage.getItem('lastUpdate');
            
            if (saved) {
                state.dragonFiles = JSON.parse(saved);
            }
            
            if (savedUpdate) {
                state.lastUpdate = new Date(savedUpdate);
            }
        }

        // Save dragon files to localStorage
        function saveToStorage() {
            localStorage.setItem('dragonFiles', JSON.stringify(state.dragonFiles));
            localStorage.setItem('lastUpdate', state.lastUpdate ? state.lastUpdate.toISOString() : null);
        }

        // Update the UI display
        function updateDisplay() {
            // Update last update time
            if (state.lastUpdate) {
                const options = { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                };
                lastUpdateEl.textContent = state.lastUpdate.toLocaleDateString('en-US', options);
            } else {
                lastUpdateEl.textContent = 'Never';
            }

            // Update file count
            const fileCount = Object.keys(state.dragonFiles).length;
            fileCountEl.textContent = `${fileCount} dragon file${fileCount !== 1 ? 's' : ''}`;

            // Update next update time
            if (state.nextUpdateTime) {
                const now = new Date();
                const diff = state.nextUpdateTime - now;
                
                if (diff > 0) {
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    nextUpdateEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    nextUpdateEl.textContent = 'Soon...';
                }
            } else {
                nextUpdateEl.textContent = '--:--:--';
            }

            // Display dragon files
            loadDragonFiles();
        }

        // Main function to fetch configs from GitHub
        async function fetchConfigs() {
            if (state.isFetching) return;
            
            state.isFetching = true;
            fetchBtn.disabled = true;
            loadingEl.style.display = 'block';
            clearErrors();
            
            try {
                showNotification('Starting to fetch configs from GitHub...');
                
                // Clear existing dragon files
                state.dragonFiles = {};
                
                // Fetch all Sub*.txt files from the repository
                // We'll try to fetch up to 70 files (Sub1.txt to Sub70.txt)
                const subFilePromises = [];
                
                for (let i = 1; i <= 70; i++) {
                    const fileName = `Sub${i}.txt`;
                    const fileUrl = `${state.baseUrl}${fileName}`;
                    
                    subFilePromises.push(
                        fetchFileContent(fileUrl, fileName)
                            .then(content => {
                                if (content) {
                                    return { index: i, content: content };
                                }
                                return null;
                            })
                            .catch(() => null)
                    );
                }
                
                // Wait for all fetches to complete
                const results = await Promise.all(subFilePromises);
                
                // Process successful results
                results.forEach(result => {
                    if (result) {
                        const dragonFileName = `dragon${result.index.toString().padStart(2, '0')}.txt`;
                        state.dragonFiles[dragonFileName] = result.content;
                    }
                });
                
                // Update state
                state.lastUpdate = new Date();
                saveToStorage();
                
                showNotification(`Successfully fetched ${Object.keys(state.dragonFiles).length} config files`);
                updateDisplay();
                resetNextUpdateTime();
                
            } catch (error) {
                showError(`Failed to fetch configs: ${error.message}`);
                console.error('Fetch error:', error);
            } finally {
                state.isFetching = false;
                fetchBtn.disabled = false;
                loadingEl.style.display = 'none';
            }
        }

        // Fetch individual file content
        async function fetchFileContent(url, fileName) {
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/plain',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    // If we get 404, the file probably doesn't exist
                    if (response.status === 404) {
                        return null;
                    }
                    throw new Error(`HTTP ${response.status} for ${fileName}`);
                }
                
                const content = await response.text();
                
                // Validate that we got some content
                if (!content || content.trim().length === 0) {
                    console.warn(`Empty content for ${fileName}`);
                    return null;
                }
                
                return content;
                
            } catch (error) {
                console.warn(`Failed to fetch ${fileName}:`, error.message);
                return null;
            }
        }

        // Display dragon files in the UI
        function loadDragonFiles() {
            filesContainer.innerHTML = '';
            
            const fileNames = Object.keys(state.dragonFiles).sort();
            
            if (fileNames.length === 0) {
                filesContainer.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--gray);">
                        <h3>No dragon files available</h3>
                        <p>Click "Fetch Configs Now" to download configs from GitHub</p>
                    </div>
                `;
                return;
            }
            
            fileNames.forEach(fileName => {
                const content = state.dragonFiles[fileName];
                const fileSize = new Blob([content]).size;
                
                // Format file size
                let sizeText;
                if (fileSize < 1024) {
                    sizeText = `${fileSize} bytes`;
                } else if (fileSize < 1024 * 1024) {
                    sizeText = `${(fileSize / 1024).toFixed(1)} KB`;
                } else {
                    sizeText = `${(fileSize / (1024 * 1024)).toFixed(2)} MB`;
                }
                
                // Truncate content for preview
                const previewContent = content.length > 500 
                    ? content.substring(0, 500) + '...' 
                    : content;
                
                const fileCard = document.createElement('div');
                fileCard.className = 'file-card';
                fileCard.innerHTML = `
                    <div class="file-header">
                        <div class="file-name">${fileName}</div>
                        <div class="file-size">${sizeText}</div>
                    </div>
                    <div class="file-content">${escapeHtml(previewContent)}</div>
                    <a href="#" class="download-btn" onclick="downloadFile('${fileName}', event)">Download ${fileName}</a>
                `;
                
                filesContainer.appendChild(fileCard);
            });
        }

        // Download a specific dragon file
        function downloadFile(fileName, event) {
            if (event) event.preventDefault();
            
            const content = state.dragonFiles[fileName];
            if (!content) {
                showError(`File ${fileName} not found`);
                return;
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`Downloaded ${fileName}`);
        }

        // Clear all dragon files
        function clearAllFiles() {
            if (Object.keys(state.dragonFiles).length === 0) {
                showNotification('No files to clear');
                return;
            }
            
            if (confirm('Are you sure you want to clear all dragon files?')) {
                state.dragonFiles = {};
                state.lastUpdate = null;
                saveToStorage();
                updateDisplay();
                showNotification('All files cleared');
            }
        }

        // Auto-update functionality
        function startAutoUpdate() {
            // Set initial next update time
            resetNextUpdateTime();
            
            // Update the countdown every second
            setInterval(() => {
                if (state.nextUpdateTime) {
                    const now = new Date();
                    
                    // If it's time for the next update
                    if (now >= state.nextUpdateTime) {
                        fetchConfigs();
                    }
                }
                updateDisplay();
            }, 1000);
            
            // Set up the hourly interval
            state.updateInterval = setInterval(() => {
                fetchConfigs();
            }, 60 * 60 * 1000); // 1 hour
        }

        // Reset the next update time
        function resetNextUpdateTime() {
            const now = new Date();
            state.nextUpdateTime = new Date(now.getTime() + 60 * 60 * 1000);
        }

        // Check when the repository was last updated
        async function checkRepositoryUpdate() {
            try {
                // We'll use the GitHub API to get repo info
                const response = await fetch('https://api.github.com/repos/Epodonios/v2ray-configs', {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const updated = new Date(data.pushed_at);
                    const options = { year: 'numeric', month: 'short', day: 'numeric' };
                    repoUpdateEl.textContent = updated.toLocaleDateString('en-US', options);
                }
            } catch (error) {
                console.warn('Could not fetch repository update info:', error);
            }
        }

        // Utility functions
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showError(message) {
            const errorEl = document.createElement('div');
            errorEl.className = 'error';
            errorEl.textContent = message;
            errorContainer.appendChild(errorEl);
            
            setTimeout(() => {
                errorEl.remove();
            }, 5000);
        }

        function clearErrors() {
            errorContainer.innerHTML = '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initial fetch if no data exists
        if (!state.lastUpdate || Object.keys(state.dragonFiles).length === 0) {
            // We'll wait a bit before auto-fetching to let the user see the interface
            setTimeout(() => {
                if (Object.keys(state.dragonFiles).length === 0) {
                    showNotification('No configs found. Click "Fetch Configs Now" to start');
                }
            }, 1000);
        }
    </script>
</body>
</html>
